window.require=function(e){switch(e){case"@apollo/client":return window.PluginApi.libraries.Apollo;case"@fortawesome/free-regular-svg-icons":return window.PluginApi.libraries.FontAwesomeRegular;case"@fortawesome/free-solid-svg-icons":return window.PluginApi.libraries.FontAwesomeSolid;case"mousetrap":return window.PluginApi.libraries.Mousetrap;case"mousetrap-pause":return window.PluginApi.libraries.MousetrapPause;case"react":return window.PluginApi.React;case"react-bootstrap":return window.PluginApi.libraries.Bootstrap;case"react-dom":return window.PluginApi.ReactDOM;case"react-intl":return window.PluginApi.libraries.Intl;case"react-router-dom":return window.PluginApi.libraries.ReactRouterDOM;case"react-select":return window.PluginApi.libraries.ReactSelect}};var e=require("react");const n="discordPresence",r={discordClientId:"1236860180407521341",discordDetailsText:"{title}",discordStateText:"from {studio_name}",discordShowImage:!1,discordLargeImageKey:"stashbox",discordLargeImageText:"Stashapp",discordShowUrlButton:!1,discordUrlButtonText:"Watch"},t=e.createContext({config:r,enabled:!1,keepAlive:!0,lastPresenceUpdate:null,state:0,ws:null,setEnabled:e=>{},setKeepAlive:e=>{}});const c=n=>{var r,c,i,o;const{PluginApi:u}=window,s=e.useContext(t),a=u.utils.InteractiveUtils.getPlayer();if(!a)return null;const l={studio_name:null!==(c=null===(r=n.scene.studio)||void 0===r?void 0:r.name)&&void 0!==c?c:"Unknown Studio",url:(null===(i=n.scene.urls)||void 0===i?void 0:i.length)?n.scene.urls[0]:"",file_duration:(null===(o=n.scene.files)||void 0===o?void 0:o.length)?n.scene.files[0].duration:0,performers:n.scene.performers.length?n.scene.performers.map((e=>e.name)).join(", "):"Unlisted Performer(s)"},d=Object.assign(Object.assign({},n.scene),l),f=function(n,r,t,c){var i=this,o=e.useRef(null),u=e.useRef(0),s=e.useRef(0),a=e.useRef(null),l=e.useRef([]),d=e.useRef(),f=e.useRef(),p=e.useRef(n),g=e.useRef(!0);p.current=n;var m="undefined"!=typeof window,w=!r&&0!==r&&m;if("function"!=typeof n)throw new TypeError("Expected a function");r=+r||0;var v=!!(t=t||{}).leading,b=!("trailing"in t)||!!t.trailing,h="maxWait"in t,E="debounceOnServer"in t&&!!t.debounceOnServer,P=h?Math.max(+t.maxWait||0,r):null;e.useEffect((function(){return g.current=!0,function(){g.current=!1}}),[]);var S=e.useMemo((function(){var e=function(e){var n=l.current,r=d.current;return l.current=d.current=null,u.current=e,s.current=s.current||e,f.current=p.current.apply(r,n)},n=function(e,n){w&&cancelAnimationFrame(a.current),a.current=w?requestAnimationFrame(e):setTimeout(e,n)},t=function(e){if(!g.current)return!1;var n=e-o.current;return!o.current||n>=r||n<0||h&&e-u.current>=P},c=function(n){return a.current=null,b&&l.current?e(n):(l.current=d.current=null,f.current)},S=function e(){var i=Date.now();if(v&&s.current===u.current&&A(),t(i))return c(i);if(g.current){var a=r-(i-o.current),l=h?Math.min(a,P-(i-u.current)):a;n(e,l)}},A=function(){},y=function(){if(m||E){var c=Date.now(),s=t(c);if(l.current=[].slice.call(arguments),d.current=i,o.current=c,s){if(!a.current&&g.current)return u.current=o.current,n(S,r),v?e(o.current):f.current;if(h)return n(S,r),e(o.current)}return a.current||n(S,r),f.current}};return y.cancel=function(){a.current&&(w?cancelAnimationFrame(a.current):clearTimeout(a.current)),u.current=0,l.current=o.current=d.current=a.current=null},y.isPending=function(){return!!a.current},y.flush=function(){return a.current?c(Date.now()):f.current},y}),[v,h,r,P,b,w,m,E,c]);return S}((()=>{var e,n;if(!s.enabled||(null===(e=s.ws)||void 0===e?void 0:e.readyState)!==WebSocket.OPEN)return;const r=s.config,t=null!==(n=a.currentTime())&&void 0!==n?n:0,c=Date.now()+1e3*(d.file_duration-t);let i={details:p(r.discordDetailsText,d),state:p(r.discordStateText,d),largeImageKey:r.discordShowImage?r.discordLargeImageKey:void 0,largeImageText:p(r.discordLargeImageText,d),endTimestamp:d.file_duration>0?c:void 0,buttons:r.discordShowUrlButton&&URL.canParse(d.url)?[{label:p(r.discordUrlButtonText,d),url:d.url}]:void 0,instance:!0};s.ws.send(JSON.stringify({clientId:r.discordClientId,presence:i}))}),500,{maxWait:5e3});function p(e,n){const r=e.replace(/{\s*(\w+?)\s*}/g,((e,r)=>{var t;return null!==(t=n[r])&&void 0!==t?t:""})).trim();return r.length<=128?r:r.substring(0,125)+"..."}return e.useEffect((()=>{a.on("playing",f),a.on("play",f),a.on("timeupdate",f),a.on("seeked",f),a.on("ended",(()=>{null!==s.config&&s.ws&&s.ws.readyState===WebSocket.OPEN&&s.ws.send(JSON.stringify({clientId:s.config.discordClientId,presence:{}}))}))}),[a]),null};
/*!
 * Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com
 * License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License)
 * Copyright 2025 Fonticons, Inc.
 */var i={prefix:"fab",iconName:"discord",icon:[576,512,[],"f392","M492.5 69.8c-.2-.3-.4-.6-.8-.7-38.1-17.5-78.4-30-119.7-37.1-.4-.1-.8 0-1.1 .1s-.6 .4-.8 .8c-5.5 9.9-10.5 20.2-14.9 30.6-44.6-6.8-89.9-6.8-134.4 0-4.5-10.5-9.5-20.7-15.1-30.6-.2-.3-.5-.6-.8-.8s-.7-.2-1.1-.2c-41.3 7.1-81.6 19.6-119.7 37.1-.3 .1-.6 .4-.8 .7-76.2 113.8-97.1 224.9-86.9 334.5 0 .3 .1 .5 .2 .8s.3 .4 .5 .6c44.4 32.9 94 58 146.8 74.2 .4 .1 .8 .1 1.1 0s.7-.4 .9-.7c11.3-15.4 21.4-31.8 30-48.8 .1-.2 .2-.5 .2-.8s0-.5-.1-.8-.2-.5-.4-.6-.4-.3-.7-.4c-15.8-6.1-31.2-13.4-45.9-21.9-.3-.2-.5-.4-.7-.6s-.3-.6-.3-.9 0-.6 .2-.9 .3-.5 .6-.7c3.1-2.3 6.2-4.7 9.1-7.1 .3-.2 .6-.4 .9-.4s.7 0 1 .1c96.2 43.9 200.4 43.9 295.5 0 .3-.1 .7-.2 1-.2s.7 .2 .9 .4c2.9 2.4 6 4.9 9.1 7.2 .2 .2 .4 .4 .6 .7s.2 .6 .2 .9-.1 .6-.3 .9-.4 .5-.6 .6c-14.7 8.6-30 15.9-45.9 21.8-.2 .1-.5 .2-.7 .4s-.3 .4-.4 .7-.1 .5-.1 .8 .1 .5 .2 .8c8.8 17 18.8 33.3 30 48.8 .2 .3 .6 .6 .9 .7s.8 .1 1.1 0c52.9-16.2 102.6-41.3 147.1-74.2 .2-.2 .4-.4 .5-.6s.2-.5 .2-.8c12.3-126.8-20.5-236.9-86.9-334.5zm-302 267.7c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.4 59.2-52.8 59.2zm195.4 0c-29 0-52.8-26.6-52.8-59.2s23.4-59.2 52.8-59.2c29.7 0 53.3 26.8 52.8 59.2 0 32.7-23.2 59.2-52.8 59.2z"]};const o=n=>{const{PluginApi:r}=window,{Icon:c}=r.components,{Button:o,Badge:u}=r.libraries.Bootstrap,{enabled:s,setEnabled:a}=e.useContext(t);return e.createElement(o,{className:"nav-utility minimal",title:"Discord Presence",onClick:()=>a(!s)},e.createElement("span",{className:"position-relative"},e.createElement(u,{"discord-presence":"status-dot",className:["position-absolute p-1 rounded-circle",(()=>{switch(n.status){case 2:return"connected";case 1:return"connecting";case 3:return"sending-updates";case 0:return"disconnected";case 4:return"connection-error"}})()].join(" ")},e.createElement("span",{hidden:!0},n.status)),e.createElement(c,{icon:i})))},u=(n,r)=>{n.toast({content:e.createElement("span",{"discord-presence":"toast"},e.createElement("h6",null,"Discord Presence"),r.content),variant:r.variant,delay:1e4})},s={info(e,...r){console.log(`[${n}] ${e}`,...r)},debug(e,...r){console.debug(`[${n}] ${e}`,...r)},error(e,...r){console.error(`[${n}] ${e}`,...r)}};const{PluginApi:a}=window,{GQL:l}=a,d=c=>{const{data:i}=l.useConfigurationQuery(),[o,a]=e.useState(r);e.useEffect((()=>{const e=i.configuration.plugins[n];a(Object.assign(Object.assign({},r),e))}),[i.configuration.plugins[n]]);const d=function(n){var r,t,c;const{PluginApi:i}=window,{hooks:o}=i,a=o.useToast(),l=null!==(r=n.socketUrl)&&void 0!==r?r:"ws://localhost:6969",[d,f]=e.useState(null===(t=n.initialEnabled)||void 0===t||t),[p,g]=e.useState(null===(c=n.initialKeepAlive)||void 0===c||c),[m,w]=e.useState(null),[v,b]=e.useState(0),[h,E]=e.useState((()=>n.pluginConfig)),P=e.useRef(null),S=e.useRef(null);e.useEffect((()=>{n.pluginConfig&&E(n.pluginConfig)}),[n.pluginConfig]);const A=n=>{s.error("Failed to connect to the companion app",n),u(a,{content:e.createElement(e.Fragment,null,"Failed to connect to the companion app."," ",e.createElement("a",{href:"https://discourse.stashapp.cc/t/discord-presence/1374",target:"_blank"},"Is the tray app running?")),variant:"warning"}),g(!1),f(!1)},y=e=>{s.error("Lost WS connection to tray app",e),u(a,{content:"Connection lost to RPC server.",variant:"danger"}),b(4)};return e.useEffect((()=>{if(!d){if(P.current){try{P.current.close()}catch(e){}P.current=null}return void b(0)}if(P.current&&P.current.readyState===WebSocket.OPEN)return;const e=new WebSocket(l);P.current=e,b(1);const n=e=>{var n,r;b(2),u(a,{content:"Connected.",variant:"success"}),null===(n=P.current)||void 0===n||n.removeEventListener("error",A),null===(r=P.current)||void 0===r||r.addEventListener("error",y)},r=e=>{b(3),w(Date.now()),null!==S.current&&window.clearTimeout(S.current),S.current=window.setTimeout((()=>{w((e=>(null===e||Date.now()-e>5e3&&b(2),e)))}),5e3)};return e.addEventListener("open",n),e.addEventListener("error",A),e.addEventListener("message",r),()=>{try{e.removeEventListener("open",n),e.removeEventListener("error",A),e.removeEventListener("error",y),e.removeEventListener("message",r)}catch(e){}if(null!==S.current&&(window.clearTimeout(S.current),S.current=null),P.current===e){try{e.close()}catch(e){}P.current=null}}}),[d,p,l]),e.useEffect((()=>()=>{if(null!==S.current&&(window.clearTimeout(S.current),S.current=null),P.current){try{P.current.close()}catch(e){}P.current=null}}),[]),e.useMemo((()=>({enabled:d,setEnabled:f,keepAlive:p,setKeepAlive:g,lastPresenceUpdate:m,state:v,config:h,ws:P.current})),[d,p,m,v,h])}({pluginConfig:o,initialEnabled:!1,socketUrl:"ws://localhost:6969"});return e.createElement(t.Provider,{value:d},c.children)};a.patch.after("App",(n=>[e.createElement(d,null,n.children)])),a.patch.after("ScenePlayer",((n,r,t)=>[t,e.createElement(c,Object.assign({},n))])),a.patch.after("MainNavBar.UtilityItems",(n=>{const{state:r}=e.useContext(t);return[e.createElement(o,{status:r}),n.children]}));
